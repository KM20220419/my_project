# 定时器

## 头文件

### lst_timer.h

<img src="C:\Users\王者荣耀\AppData\Roaming\Typora\typora-user-images\image-20251005141052187.png" alt="image-20251005141052187" style="zoom:50%;" />

## 结构体 client_data

<img src="C:\Users\王者荣耀\AppData\Roaming\Typora\typora-user-images\image-20251005141136279.png" alt="image-20251005141136279" style="zoom:50%;" />







## utils_timer以及sort_timer_lst类

其中链表sort_timer_lst容器中存放的是utils_timer类型



<img src="C:\Users\王者荣耀\AppData\Roaming\Typora\typora-user-images\image-20251005203547049.png" alt="image-20251005203547049" style="zoom:50%;" />

升序链表 sort_timer_lst 中存放的是一个个 **定时器对象（`util_timer`）**，
 每个定时器对应一个客户端连接（`client_data`）的超时管理。



## setnonblocking()函数

用于将socket设置为非阻塞

```
int Utils::setnonblocking(int fd)
{
    int old_option = fcntl(fd，F_GETFL);  // 使用fctnl拿到fd的所有状态标志位（是否阻塞，可读等），保存到old_option中
    int new_option = old_option | O_NONBLOCK;  //加入 O_NONBLOCK标志位，表示非阻塞
    fcntl(fd, F_SFTFL, new_option);  //将其写回到fd中，其中F_SFTFL表示只改行为标志，不改读写权限。
    return old_option;  //返回旧的，作为备份
}
```

`F_GETFL`：获取当前文件描述符的状态标志。

`F_SETFL`：重新设置文件描述符的状态标志。



## epoll中的oneshot

```
void Utils::addfd(int epollfd, int fd, bool one_shot, int TRIGMode)
{
    eppll_event event;

    event.data.fd = fd;
    // 设置边缘触发模式
    if (1 == TRIGMode)
    {
        event.events = EPOLLIN | EPOLLET | EPOLLRDHUP;
    }
    else
    {
        event.events = EPOLLIN | EPOLLRDHUP
    }
    // 一次性触发
    if (one_shot)
        event.events |= EPOLLONESHOT;
    epoll_ctl(epollfd, EPOLL_CTL_ADD, fd, &event);
    // ET模式下，要保证socket为非阻塞模式
    setnonblocking(fd);
}
```

这里是将内核事件表注册读事件，ET模式，选择开启EPOLLONESHOT写到一个函数中

其中EPOLLONESHOT表示**事件发生后，epoll 自动把这条 fd 屏蔽掉，不再给你发任何通知，直到你手动重新“激活”它。**

ET与EPOLLONESHOT的区别：

| 维度                   | ET 模式                                                    | ONESHOT 模式                                    |
| :--------------------- | ---------------------------------------------------------- | ----------------------------------------------- |
| **解决什么问题**       | \*\*“状态变化”\*\*只报一次，**缓冲区有数据就不再报**       | \*\*“事件句柄”\*\*只报一次，**之后 fd 被冻结**  |
| **触发条件**           | 缓冲区 **从空→有数据** 时通知一次                          | **任何事件**到来就通知一次，**然后直接拉黑 fd** |
| **是否还需要处理数据** | **必须一次性读空**，否则后续不再通知                       | **事件到达后 fd 直接失效**，**数据可以不读完**  |
| **如何再次收到事件**   | **把数据读空**，**等待下一次缓冲区从空→有**（ET 重新触发） | **手动 `EPOLL_CTL_MOD` 重新激活**               |
| **能否和 LT 一起用**   | **不能**（ET 本身就是和 LT 对立的）                        | **可以**（ONESHOT 和 LT/ET 都能叠加）           |

| 模式             | 第一次 `epoll_wait` | 第二次 `epoll_wait`                      | 第三次 `epoll_wait`    |
| ---------------- | ------------------- | ---------------------------------------- | ---------------------- |
| **LT**           | 通知                | 通知                                     | 通知（直到数据被读空） |
| **ET**           | 通知 **一次**       | **不通知**（缓冲区一直有数据，状态没变） | **不通知**             |
| **ET + ONESHOT** | 通知 **一次**       | **永远不通知**（fd 被冻结）              | **永远不通知**         |



## 信号与epoll

   [系统信号]
        │
        ▼
   sig_handler() （信号处理函数）
        │
        ├── send(u_pipefd[1], &sig, 1, 0)
        ▼
   epoll_wait() 监听到 u_pipefd[0] 可读
        │
        ▼
   读取信号 → 根据信号执行 timer_handler() 或关闭服务器



<img src="C:\Users\王者荣耀\AppData\Roaming\Typora\typora-user-images\image-20251006212127340.png" alt="image-20251006212127340" style="zoom:50%;" />





## socketpair

<img src="C:\Users\王者荣耀\AppData\Roaming\Typora\typora-user-images\image-20251006212551685.png" alt="image-20251006212551685" style="zoom:50%;" />

<img src="C:\Users\王者荣耀\AppData\Roaming\Typora\typora-user-images\image-20251006212618612.png" alt="image-20251006212618612" style="zoom:50%;" />

![image-20251006213326820](C:\Users\王者荣耀\AppData\Roaming\Typora\typora-user-images\image-20251006213326820.png)

![image-20251006212654318](C:\Users\王者荣耀\AppData\Roaming\Typora\typora-user-images\image-20251006212654318.png)

```
int main() {
    // ... 服务器初始化
    Utils utils;
    utils.init(TIMESLOT);

    // 创建 socketpair 管道
    int pipefd[2];
    socketpair(PF_UNIX, SOCK_STREAM, 0, pipefd);
    Utils::u_pipefd = pipefd;

    // 设置管道非阻塞
    utils.setnonblocking(pipefd[1]);

    // 将管道读端添加到 epoll
    utils.addfd(epollfd, pipefd[0], false, 0);

    // 注册信号
    utils.addsig(SIGALRM, utils.sig_handler, false);
    utils.addsig(SIGTERM, utils.sig_handler, false);

    // 启动定时器
    alarm(TIMESLOT);

    // epoll 主循环
    while (!stop_server) {
        int num = epoll_wait(epollfd, events, MAX_EVENT_NUMBER, -1);
        // 处理事件 ...
    }
}

```







将信号加入到epoll中，是为了监听系统调用发送的信号

```
+------------------------+
|        内核信号        |
| (SIGALRM / SIGTERM...) |
+-----------+------------+
            |
            | write(sig) → u_pipefd[1]
            v
+----------------------------+
|     epoll_wait 主线程      |
| 监听: listenfd, connfd,    |
|        pipefd[0]           |
+------------+---------------+
             |
             | 可读事件(pipefd[0])
             v
     读取信号 → 调用 timer_handler()

```

<img src="C:\Users\王者荣耀\AppData\Roaming\Typora\typora-user-images\image-20251006213232104.png" alt="image-20251006213232104" style="zoom:50%;" />
